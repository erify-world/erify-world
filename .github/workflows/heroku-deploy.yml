name: Deploy erify-bot to Heroku

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install
        run: npm ci || npm install

      - name: Build (optional)
        run: npm run build --if-present

      - name: Run tests (optional)
        run: npm test --if-present

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "erify-bot"
          heroku_email: "you@example.com"
          usedocker: false
          dontuseforce: true

      - name: Notify Discord on Successful Deploy
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": "@everyone",
              "embeds": [{
                "title": "ğŸ‰ ERIFY Bot is Crowned & Live! ğŸš€ğŸ‘‘",
                "description": "ERIFY Bot has successfully **deployed to production** with a fully automated CI/CD pipeline. Every push to `main` keeps the bot updated and the flame alive. ğŸ”¥",
                "color": 16753920,
                "thumbnail": {"url": "https://i.imgur.com/3ZUrjUP.png"},
                "fields": [
                  {"name": "ğŸ”‘ Highlights", "value": "âœ… **Continuous Deployment** â†’ `git push` = live bot\nâœ… **Scalable Worker Dyno** â†’ 24/7 uptime on Heroku\nâœ… **Heartbeat Verified** â†’ `[BOOT]` â†’ `[READY]`\nâœ… **Debug Made Simple** â†’ logs, dyno checks, rollbacks", "inline": false},
                  {"name": "ğŸ“¡ Current Status", "value": "âœ… **Online** | ğŸ”¥ğŸ‘‘ Listening for commands", "inline": true},
                  {"name": "ğŸ–¥ï¸ Monitor Logs", "value": "```bash\nheroku logs --tail -a erify-bot\n```", "inline": true},
                  {"name": "ğŸ›¡ï¸ Rollback (if needed)", "value": "```bash\nheroku releases -a erify-bot\nheroku releases:rollback vNN -a erify-bot\n```", "inline": false},
                  {"name": "ğŸš€ Next in the ERIFY Empire", "value": "ğŸ‘‘ Concurrency safeguards (latest deploy wins)\nğŸ‘‘ Manual hotfix trigger in Actions\nğŸ‘‘ Expand to **erify-world ğŸŒ**", "inline": false}
                ],
                "footer": {"text": "Deployed by GitHub Actions | Powered by ERIFY Automation ğŸ”¥"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }' 
